# bitcoin项目贡献流程

比特币核心项目采用开放的贡献者模型，任何人可以以同行评审、测试或补丁的形式做贡献。

首先，在结构上，没有核心开发者，开源通常围绕着任人唯贤的原则，不过出于实际目的，一些层次结构是必要的。因此，有负责合并拉取请求的存储库维护者，以及负责发布周期和维护者的整体合并、审核和任命的首席维护者。

## 入门

审查和测试受到高度重视，也是作为新贡献者可以做出贡献的最有效方式。与打开拉取请求相比，这部分涉及更多有关代码和流程的知识，在开始贡献之前，需要先熟悉 Bitcoin Core 构建系统和测试，有许多不同难度的未解决问题等待修复。如果没有找到可以贡献的地方，可以查看问题列表，其中一些可能不再适用。有疑惑的可以进行提问评论，还可以参加每周的 Bitcoin Core PR Review Club会议。

### 良好的首期标签

`good first issue`标签的目的是突出哪些问题适合没有深入了解代码库的新贡献者。

任何人都可以解决好的第一个问题，如果它们在较长时间内仍未解决，则贡献者很有可能会解决它们。

无需请求许可即可开始处理问题，但如果打算对此进行处理，也鼓励发表评论。这将帮助其他贡献者监控正在积极解决的问题，并且也是在需要时请求帮助的有效方式。

## 沟通渠道

大多数关于比特币核心开发的交流都发生在 IRC 上，在`#bitcoin-core-dev`Libera Chat的 频道中。参与 IRC 的最简单方法是使用 Web 客户端web.libera.chat。

关于代码库改进的讨论发生在 GitHub 问题和拉取请求中。

在处理补丁集之前，应使用开发人员讨论复杂或有争议的共识或 P2P 协议更改。

## 贡献者工作流程

代码库使用“贡献者工作流”维护，其中每个人都要使用“拉取请求”（PR）贡献补丁建议。这有利于社会贡献、易于测试和同行评审。

要贡献补丁，工作流程如下：

1. Fork 存储库（仅限第一次）
2. 创建主题分支
3. 提交补丁

对于 GUI 相关的问题或拉取请求，应使用https://github.com/bitcoin-core/gui存储库。对于所有其他问题和拉取请求，应使用https://github.com/bitcoin/bitcoin节点存储库。

所有 monotree 存储库的主分支都是相同的。

根据经验，仅修改的所有内容都是仅限`src/qt`GUI 的拉取请求。然而：

- 对于全局重构或其他横向更改，应使用节点存储库。
- 对于与 GUI 相关的构建系统更改，应使用节点存储库，因为更改需要构建系统审核人员进行审核。
- 更改`src/interfaces`需要转到节点存储库，因为它们可能会影响钱包等其他组件。

对于包含构建系统和界面更改的大型 GUI 更改，建议首先针对 GUI 存储库打开拉取请求。当同意继续更改时，可以将包含构建系统和接口更改的拉取请求提交到节点存储库。

必须遵循开发人员说明中的项目编码约定。

### 提交补丁

一般来说，提交应该是原子的 ，差异应该易于阅读。因此，不要将任何格式修复或代码移动与实际代码更改混合在一起。确保每个单独的提交都是自己成功构建，没有警告、错误、回归或测试失败。

默认情况下，提交消息应该是详细的，由一个简短的主题行（最多 50 个字符）、一个空行和作为单独段落的详细解释文本组成，除非单独的标题是不言自明的（例如“更正了 init.cpp 中的错字") 在这种情况下，一个标题行就足够了。提交消息应该对将来阅读代码的人有所帮助，因此请解释决定的原因。

如果特定提交引用了另一个问题，请添加引用。例如：`refs #1234`或`fixes #4321`。使用`fixes`or`closes`关键字会导致在合并拉取请求时关闭相应的问题。

提交消息不应包含任何`@`提及（以“@”为前缀的用户名）。

有关 Git 的更多信息，请参阅Git 手册。

- 将更改推送到您的 fork
- 创建拉取请求

### 创建拉取请求

拉取请求的标题应该以拉取请求影响的组件或区域作为前缀。有效区域为：

- `consensus` 对于共识关键代码的更改
- `doc` 对于文档的更改
- `qt`或`gui`更改比特币-qt
- `log` 用于更改日志消息
- `mining` 更改挖矿代码
- `net`或`p2p`更改对等网络代码
- `refactor` 对于不改变行为的结构性变化
- `rpc`，`rest`或`zmq`对 RPC、REST 或 ZMQ API 的更改
- `script` 更改脚本和工具
- `test`，`qa`或`ci`对单元测试、QA 测试或 CI 代码的更改
- `util`或`lib`更改实用程序或库
- `wallet` 更改钱包代码
- `build` 用于更改 GNU Autotools 或可复制的构建

例子：

```
consensus: Add new opcode for BIP-XXXX OP_CHECKAWESOMESIG
net: Automatically create onion service, listen on Tor
qt: Add feed bump button
log: Fix typo in log message
```

拉请求的主体应该包含足够的描述*什么*的修补程序，更重要的是，*为什么*，说明理由和推理。您应该包括对任何讨论（例如，其他问题或邮件列表讨论）的引用。

新拉取请求的描述不应包含任何`@`提及。当 PR 被合并时，PR 描述将包含在提交消息中，并且描述中提到的任何用户都会在每次 Bitcoin Core 的分叉复制合并时收到烦人的通知。相反，在 PR 的后续评论中提及任何用户名。

### 翻译变化

不应将翻译作为拉取请求提交，有关帮助翻译的更多信息，需参阅翻译流程。

### 正在进行中的更改和征求意见

如果不考虑合并拉取请求，请在标题前加上 [WIP] 或使用拉取请求正文中的任务列表来指示任务正在挂起。

### 地址反馈

在这个阶段应该期待其他贡献者的评论和评论。可以通过在本地提交并推送到分支，拉取请求添加更多提交，直到满足所有反馈。

代码审查是开发过程中一个繁重但重要的部分，因此，某些类型的拉取请求会被拒绝。一般来说，如果**改进**不保证所需的**审查工作**，PR 很有可能被拒绝。由 PR 作者来说服审稿人更改需要审阅工作，如果审稿人对 PR “Concept NACK'ing”，作者可能需要提出论点和/或进行研究来支持他们建议的更改。

### 压扁提交

如果拉取请求包含修复提交（重复更改同一行代码的提交）或太细粒度的提交，可能会被要求在审查之前压缩提交。基本的压缩工作流程如下所示。

```
git checkout your_branch_name
git rebase -i HEAD~n
# n is normally the number of commits in the pull request.
# Set commits (except the one in the first line) from 'pick' to 'squash', save and quit.
# On the next screen, edit/refine commit messages.
# Save and quit.
git push -f # (force push to GitHub)
```

如果需要，请更新生成的提交消息。它应该读作一个连贯的信息。在大多数情况下，这意味着不仅仅是列出临时提交。

如果在压缩或其他 git 工作流程方面遇到问题，可以在 GitHub 网络界面的右侧边栏中启用“允许维护者编辑”，并在拉取请求中寻求帮助。

请避免为同一更改创建多个拉取请求。使用已经打开（或之前创建）的拉取请求来修改更改。这会保留之前针对相应变更集进行的讨论和审查。

同行评审所需的时间是不可预测的，并且会因拉取请求而异。

### 重新调整更改

当拉取请求与目标分支发生冲突时，可能会被要求在当前目标分支的基础上对其进行变基。该`git rebase`命令将负责在新基础上重建您的提交。

该项目旨在拥有一个干净的 git 历史记录，其中代码更改仅在非合并提交中进行。这简化了可审计性，因为可以假设合并提交不包含任意代码更改。合并提交应该被签名，并且生成的 git 树哈希必须是确定性和可重现的。[/contrib/verify-commits 中](https://github.com/bitcoin/bitcoin/blob/master/contrib/verify-commits)的脚本会 检查这一点。

在 rebase 之后，鼓励评论者签署强制推送。使用生产力说明中`git range-diff`解释的工具，这应该相对简单。为了避免不必要的审查流失，维护人员通常会首先合并受到最多审查关注的拉取请求。

## 拉取请求

应始终关注补丁集。例如，拉取请求可以添加功能、修复错误或重构代码；但不是混合物。还请避免尝试做太多、过大或过于复杂的超级拉取请求，因为这会使审查变得困难。

### 特征

添加新功能时，必须考虑该功能在加入后可能需要的长期技术债务和维护。在提出需要维护的新功能之前，请考虑是否愿意维护它（包括错误修复）。如果将来没有维护者的特性变得孤立，它们可能会被存储库维护者删除。

### 重构

重构是任何软件项目演变的必要部分。以下指南涵盖了重构项目的拉取请求。

重构分为三类：仅代码移动、代码样式修复和代码重构。一般来说，重构拉取请求不应将这三种活动混合在一起，以使重构拉取请求易于审查和无争议。在所有情况下，重构 PR 不得更改拉取请求中代码的行为（错误必须按原样保留）。

项目维护人员的目标是快速完成重构拉取请求，因此尽可能使它们简短、不复杂且易于验证。

重构代码的拉取请求不应由新贡献者提出。它需要一定程度的经验才能知道代码所属的位置并了解完整的后果（包括开放拉取请求的变基工作）。

维护人员可能会立即关闭琐碎的拉取请求或重构代码并没有明显好处的拉取请求，以减少不必要的审查工作量。

## “做决定的过程

以下内容适用于比特币核心项目（以及 libsecp256k1 等相关项目）的代码更改，请勿与比特币网络协议的整体共识更改混淆。

拉取请求是否合并到比特币核心取决于项目合并维护者和最终的项目负责人。

维护者会考虑补丁是否符合项目的一般原则；符合纳入的最低标准；并将判断贡献者的普遍共识。

一般来说，所有拉取请求必须：

- 有一个清晰的用例，修复一个可证明的错误或为项目提供更大的利益（例如重构以实现模块化）；
- 得到良好的同行评审；
- 在适当的情况下进行单元测试、功能测试和模糊测试；
- 遵循代码风格指南（[C++](https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md)，[功能测试](https://github.com/bitcoin/bitcoin/blob/master/test/functional/README.md)）；
- 不破坏现有的测试套件；
- 在修复错误的地方，在可能的情况下，应该进行单元测试来演示错误并证明修复。这有助于防止回归。
- 当代码行为发生变化时，更改相关注释和文档。

更改比特币共识规则的补丁比正常情况要复杂得多，因为它们影响整个生态系统，因此必须在广泛的邮件列表讨论之前进行，并具有编号的 BIP。虽然每种情况都不同，但由于同行评审和共识建立要求的增加，人们应该准备比其他类型的补丁花费更多的时间和精力。

### 同行评审

任何人都可以参与由拉取请求中的评论表达的同行评审。通常，审查人员会审查代码是否存在明显错误，并测试补丁集并就补丁的技术优点发表意见。项目维护者在确定是否存在合并拉取请求的共识时会考虑同行评审（请记住，讨论可能已经在 GitHub、邮件列表和 IRC 讨论中展开）。

#### 概念审查

评论可以是概念性评论，其中评论者留下评论

- `Concept (N)ACK`，意思是“我（不）同意这个拉取请求的总体目标”，
- `Approach (N)ACK`，意思是`Concept ACK`，但“我不（不）同意这种改变的方法”。

A`NACK`需要说明为什么不值得进行更改。没有附带推理的 NACK 可以被忽略。

#### 代码审查

在对更改达成概念性协议后，可以提供代码审查。评论以 开始`ACK BRANCH_COMMIT`，其中`BRANCH_COMMIT`是 PR 分支的顶部，然后是评论者如何进行评论的描述。拉取请求注释中使用以下语言：

- “我已经测试过代码”，除了运行单元测试、功能测试或模糊测试之外，还涉及特定变更的手动测试，如果手动测试是如何完成的不明显，则应进行描述；
- “我没有测试过代码，但我已经检查过它，看起来不错，我同意它可以合并”；
- “nit”指的是微不足道的，通常是非阻塞问题。

项目维护者保留使用常识判断权衡同行评审意见的权利，也可以根据优点进行权衡。随着时间的推移，对项目表现出更深层次的承诺和理解或具有明确领域专业知识的审阅者可能自然而然地拥有更大的权重，正如人们在各行各业中所期望的那样。

如果补丁集影响共识关键代码，则在讨论和同行评审要求方面的门槛会高得多，请记住，错误可能会给更广泛的社区带来非常高的代价。这包括重构关键共识代码。

如果补丁集提议更改比特币共识，则必须在邮件列表和 IRC 上进行广泛讨论，并附有广泛讨论的 BIP，并且具有普遍被广泛认为是值得更改的技术共识。维护者。

### 寻找审稿人

由于大多数审阅者本身就是拥有自己项目的开发人员，因此审阅过程可能会相当漫长，需要一定的耐心。如果您发现几个月来一直在等待拉取请求引起注意，可能有多种原因，其中一些您可以采取以下措施：

- 这可能是因为即将发布的功能冻结。在此期间，只考虑错误修复。如果您的拉取请求是一项新功能，则在发布之后才会对其进行优先排序。等待发布。
- 这可能是因为您建议的更改对人们没有吸引力。与需要努力并意味着他们足够关心花时间在你的贡献上的 nits 和批评不同，雷鸣般的沉默是对给定变化的广泛（温和）不喜欢的好兆头（因为人们并不认为*其他人*实际上不会喜欢提案）。不过，不要把它放在个人身上！相反，再仔细看看你的建议，看看它是否：改变太多、太宽泛、不符合 [开发人员说明](https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md)、危险或不安全、写得乱七八糟等等。识别并解决任何你发现的问题。然后在 IRC 上询问是否有人可以对概念本身发表意见。
- 这可能是因为你的代码对于除了少数人之外的所有人来说太复杂了，而那些人可能没有意识到你的拉取请求甚至存在。[Git Blame 功能](https://help.github.com/articles/tracing-changes-in-a-file/)是找到合格且关心您所接触代码的人的一个好方法 。只需查找上次修改您正在更改的代码的人，看看您是否可以找到他们并轻推他们。但是，不要不停地轻推。
- 最后，如果所有其他方法都失败了，请在 IRC 或其他地方请求某人查看您的拉取请求。如果您认为您无缘无故地等待了不合理的长时间（例如，一个多月）（例如更改了几行等），这完全没问题。当其他人要求对他们的代码提供反馈时，尝试回报他们的帮助，并且宇宙平衡了。
- 请记住，您在等待期间能做的最好的事情就是给他人评论！

## 向后移植

安全性和错误修复可以从`master`发布分支向后移植。如果向后移植是非平凡的，那么打开一个额外的 PR 来向后移植更改可能是合适的，但只能在原始 PR 合并之后。否则，backports 将分批进行，维护者将`Needs backport (...)`在需要时使用适当的标签（原作者无需担心）。

向后移植应在提交正文中包含以下元数据：

```
Github-Pull: #<PR number>
Rebased-From: <commit hash of the original commit>
```

## 发布政策

项目负责人是每个比特币核心版本的发布经理。

## 版权

通过向此存储库做出贡献需同意在 MIT 下许可工作，除非`contrib/debian/copyright`在文件本身中或顶部另有说明。在不是原作者的情况下贡献的任何作品都必须包含其原始作者和来源的许可标头。