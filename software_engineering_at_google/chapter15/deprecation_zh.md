# chapter 15

## **弃用**



*我爱最后期限。我爱它们飞驰而过时的呼啸声。*

*——道格拉斯**.**亚当斯*

所有系统老化。尽管软件是一种数字资产，其本身的物理部分不会退化，但随着时间的推移，新技术、库、技巧、语言和其他环境变化会使现有系统过时。因为旧的系统偏离周围的生态系统，它们需要持续、专业、更多精力的维护。将精力投入于关闭过时系统往往更好，而不是让它们无限期地与替代它们的系统并驾齐驱。但仍在运行的过时系统的数量表明，在实践中，这样做并非微不足道。我们将有序地迁移并最终移除过时系统的过程称为弃用。

与编程相比，弃用是更准确地属于软件工程学科的另一个主题，因为它需要考虑如何随着时间的推移管理系统。对于长期运行的软件生态系统，规划和执行弃用可以通过消除系统中随时间积累的冗余和复杂性来正确地降低资源成本和提高速度。另一方面，不受欢迎的系统可能比单独使用它们的成本更高。虽然弃用系统需要额外的工作，但可以在系统设计期间计划弃用，以便更容易最终停用和移除系统。折旧可能会影响从单个函数调用到整个软件堆栈的系统。 具体地，下面的大部分内容集中在代码级别的弃用。

与我们在本书中讨论的大多数其他主题不同，谷歌仍在学习如何最好地弃用和移除软件系统。这一章描述了我们已经学到的教训，因为我们已经否决了大型和大量使用的内部系统。有时，它能像预期的那样工作，有时却不能，但在工业界，删除过时系统的一般问题仍然是一个困难和不断发展的问题。

本章主要讨论不推荐的技术系统，而不是最终用户产品。考虑到面向外部的API只是另一种产品，而内部API可能拥有自认为是最终用户的消费者，这种区分有点武断。尽管许多原则适用于拒绝公共产品，但我们在这里关注的是在系统所有者能够了解其使用情况的情况下，淘汰和删除过时系统的技术和政策方面。






### **为什么要弃用？**

我们对折旧的讨论始于一个基本前提，即代码是一种负债，而不是一种资产。毕竟，如果代码是一种资产，我们为什么还要花时间去拒绝和删除过时的系统呢?代码有成本，其中一些是在创建系统的过程中承担的，但许多其他成本是在整个系统生命周期中维护时承担的。这些持续的成本，比如维持一个系统运行所需的运营资源，或者随着周围生态系统的进化而不断更新其代码库的努力，意味着在保持一个老化系统运行或努力关闭它之间进行权衡是值得的。

一个系统的年代并不足以证明它的过时。一个系统可以经过几年精心设计，成为软件形式和功能的缩影。一些软件系统，如LaTeX排版系统，在过去的几十年里得到了改进，尽管仍在发生变化，但变化非常少。仅仅因为一些东西是旧的，并不意味着它是过时的。

弃用最适用于明显过时的系统，并且存在提供类似功能的替换。新系统可以更有效地利用资源，具有更好的安全性能，以更可持续的方式构建，或者只是修复漏洞。让两个系统完成相同的任务似乎不是一个紧迫的问题，但随着时间的推移，维护它们的成本可能会大幅增加。用户可能需要使用新系统，但仍有一些依赖于使用旧系统。

这两个系统可能需要相互接口，这就需要复杂的转换代码。随着两个系统的发展，它们可能会彼此依赖，从而使最终移除其中任何一个变得更加困难。从长远来看，我们发现，拥有多个执行相同功能的系统也会阻碍新系统的发展，因为新系统仍然需要保持兼容性。花费精力去移除旧的系统可以得到回报，因为替换系统现在可以发展得更快。

早些时候，我们断言“代码是负债，而不是资产。”如果这是真的，为什么我们要花这本书的大部分时间来讨论构建可以存在几十年的软件系统的最有效的方法呢?为什么要花那么多精力去创造更多的代码，而这些代码最终只会出现在资产负债表的负债一侧?代码本身并没有带来价值:它所提供的功能才有价值。如果该功能满足用户需求，那么它就是一种资产:实现该功能的代码只是实现该目的的一种手段。如果我们可以从一行可维护的、可理解的代码中获得与10,000行复杂的意大利面条式代码相同的功能，我们会选择前者。代码本身也有成本——代码越简单，同时保持相同数量的功能，就越好。我们不应该关注我们能生成多少代码，或者我们的代码库有多大，我们应该关注每个代码单元能交付多少功能，并尽量最大化这个指标。做到这一点最简单的方法之一不是编写更多代码并希望获得更多功能;它删除了不再需要的多余代码和系统。弃用策略和过程使之成为可能。

尽管弃用是有用的，但我们从谷歌了解到，从做弃用的团队和这些团队的客户的角度来看，组织对同时进行合理的弃用工作量是有限制的。例如，虽然每个人都喜欢新铺的道路，但如果公共工程部门决定同时关闭所有道路进行铺路，没有人会去任何地方。通过集中他们的努力，铺路工人可以更快地完成特定的工作，同时也允许其他交通取得进展。同样，谨慎地选择弃用项目，然后致力于完成它们，这很重要。

### **为什么弃用这么难？**

我们在这本书的其他地方已经提到了Hyrum定律，但是值得在这里重复它的适用性:系统的用户越多，用户以意想不到的方式使用它的可能性就越高，并且也就越难弃用和删除这样的系统。它们的用法只是“碰巧管用”，而不是“保证管用”。在这种情况下，移除一个系统可以被认为是最终的改变:我们不只是改变行为，我们是完全移除行为!这种彻底的改变将使许多意想不到的依赖者摆脱出来。

更复杂的是，在提供相同(或更好)功能的新系统出现之前，弃用通常不是一个选项。新系统可能更好，但它也不同:毕竟，如果它与过时的系统完全相同，它不会为迁移到它的用户提供任何好处(尽管它可能有益于运营它的团队)。这种功能上的差异意味着新系统和旧系统之间很少有一对一的匹配，并且必须在新系统的环境中中评估旧系统的每次使用。

另一个令人惊讶的不愿弃用的是对旧系统的情感依恋，特别是那些弃用者帮助创建的系统。这种厌恶更改的一个例子发生在系统地删除谷歌中的旧代码时:我们偶尔会遇到“我喜欢这个代码!”要说服工程师拆除他们花费多年建造的东西是非常困难的。这是一个可以理解的反应，但最终会无效的:如果一个系统是过时的，它会给组织带来净成本，应该被删除。我们解决了在谷歌中保存旧代码的问题，其中一种方法是确保源代码库不仅可以在主干上搜索，而且可以在历史上搜索。即使已经删除的代码也可以再次找到(参见第17章)。

在谷歌中有一个古老的笑话:有两种方法:一种已经被弃用，另一种还没有准备好。这通常是新解决方案“几乎”完成的结果，也是在复杂且快节奏的技术环境中工作的不幸现实。

谷歌工程师已经习惯了在这种环境下工作，但它仍然令人不安。良好的文档、大量的路标和专家团队帮助处理废弃和迁移过程，这些都能让你更容易地知道你是应该使用带有缺点的旧东西，还是使用带有不确定性的新东西。

最后，在政治上，资助和执行折旧工作可能很困难;组建一个团队和花时间清除过时的系统需要花费真正的金钱，而什么都不做和让系统在无人看管的情况下运行的成本是不可观察到的。要让相关的利益相关者相信弃用的努力是值得的是困难的，特别是当它们对新功能的开发产生负面影响时。研究技术，如在第7章中描述的那些，可以提供具体的证据，说明一个弃用是值得的。

考虑到弃用和删除过时软件系统的困难，用户通常更容易就地发展一个系统，而不是完全替换它。增量心态并不能完全避免弃用过程，但它确实将其分解成更小、更易于管理的块，从而产生增量的好处。在谷歌中，我们观察到迁移到全新的系统非常昂贵，而且成本经常被低估。通过就地重构可以保持现有系统的运行，同时使其更容易地向用户传递价值。

### **设计期间的弃用**

像许多工程活动一样，软件系统的弃用可以在最初构建这些系统时进行计划。编程语言、软件架构、团队组成，甚至公司政策和文化的选择，都会影响到一个系统在其使用寿命结束后，移除它的容易程度。

设计系统从而使它们最终被弃用的概念在软件工程中可能是激进的，但在其他工程学科中是常见的。以核电站为例，这是一个极其复杂的工程。作为核电站设计的一部分，它的最终衰变-任务在一个生命周期的有效服务后，必须被考虑在内，甚至为此拨出资金。当工程师们知道核电站最终需要退役时，许多设计选择都会受到影响。

不幸的是，软件系统很少经过深思熟虑的设计。许多软件工程师被吸引到建造和推出新系统的任务上，而不是主要为现有系统服务。包括谷歌在内的许多公司的企业文化都强调快速制造和交付新产品，这往往会阻碍设计从一开始就考虑到弃用。尽管人们普遍认为软件工程师是数据驱动的自动机，但从心理上和逻辑上来讲，我们很难为我们正在努力建造的创造物的最终消亡做出计划。

那么，在设计将来更容易弃用的系统时，我们应该考虑哪些因素呢?以下是我们鼓励谷歌的工程团队提出的几个问题:

-  对于消费者来说，从我的产品迁移到潜在的替代品有多容易?

- 如何逐步替换系统的某些部分?

这些问题中的许多都与系统如何提供和使用依赖项有关。有关如何管理这些依赖关系的更详细讨论，请参见第16章。

最后，我们应该指出，当组织首次决定构建项目时，就决定是否长期支持项目。在软件系统存在之后，唯一剩下的选项是支持它，小心地弃用它，或者当某些外部事件导致它崩溃时让它停止运行。这些都是有效的选项，它们之间的权衡是特定于组织的。当公司破产时，一个只有一个项目的新公司会不假思索地扼杀它，但一个大公司在考虑移除旧项目时，需要更仔细地考虑对其对组合投资和声誉的影响。如前所述，谷歌仍在学习如何最好地利用我们自己的内部和外部产品进行这些权衡。

简而言之，不要启动组织没有承诺支持组织预期寿命的项目。即使组织选择弃用并删除项目，仍然会有成本，但是可以通过在工具和政策上的计划和投资来降低成本。

### **弃用的类型**

弃用不是一种单一的过程，而是一个连续的过程，从“我们希望有一天会关闭它”到“这个系统明天就会消失，用户们最好做好准备。”一般来说，我们把这一连续统一体分为两个独立的领域:建议性和强制性。

#### **建议性弃用**

建议性弃用的是那些没有截止日期，对组织来说不是高优先级的(并且公司不愿意为它们投入资源)。这些也可能被贴上“有志贬低”的标签:团队知道系统已经被替换了，尽管他们希望客户最终会迁移到新系统，但他们近期并没有提供支持以帮助客户迁移或删除旧系统的计划。这种弃用通常缺乏强制执行:我们希望客户端移动，但不能强迫他们移动。正如我们在SRE的朋友会很乐意告诉你的:“希望不是策略。”

建议性弃用是一个很好的工具，可以宣传新系统的存在，并鼓励早期采用该系统的用户开始尝试。这样的新系统不应该在测试阶段考虑:它应该为生产使用和负载做好准备，并且应该为无限期地支持新用户做好准备。当然，任何新系统都会经历成长的痛苦，但是在旧系统以任何方式被弃用之后，新系统将成为组织基础设施的关键部分。

我们在谷歌中看到的一种情况是，当新系统为用户提供了令人信服的好处时，建议性的弃用有很强的好处。在这些情况下, 简单地通知用户这个新系统，并为他们提供迁移到该系统的自助工具，通常会鼓励他们采用该系统。然而，这些好处不能是简单地增加:它们必须是变革性的。用户将不愿为边际利益而自行迁移，即使是具有巨大改进的新系统，如果只使用建议性的弃用工作，也不会获得完全的采用。

建议性弃用允许系统作者向期望的方向推动用户，但是不应该指望他们来完成大部分迁移工作。人们通常倾向于简单地对旧系统发出弃用警告，然后不做任何进一步的努力就退出。我们在谷歌的经验是，这可能会导致(稍微)较少的过时系统的新用法，但它很少会使得团队主动迁移。旧系统的现有用途对其产生了一种概念（或技术）上的吸引力：相对较多的旧系统的使用将倾向于获得大量的新用途，无论我们说多少，“请使用新的系统”。除非更积极地鼓励用户迁移，否则旧系统将继续需要维护和其他资源。 

#### **强制弃用**

这种积极的鼓励以强制弃用的形式出现。这种弃用通常伴随着一个删除过时系统的截止日期:如果用户在该日期之后还继续依赖它，他们会发现自己的系统不能再继续工作。

与直觉相反的是，推进强制废弃工作的最佳方式是将迁移用户的专业知识本地化到单个专家团队中——通常是负责完全删除旧系统的团队。这个团队需要帮助其他人从过时的系统中迁移出去，并且能够开发可以在整个组织中使用的经验和工具。许多这样的迁移可以用第22章中讨论的工具来实现。

为了让强弃用真正起作用，它的时间表需要有一个强制机制。这并不意味着时间表不能更改，只是授权管理弃用流程的团队，对于多次警告后仍然不进行迁移的用户，将其破坏掉。如果没有这个功能，对于客户来说，为了支持特性或其他更紧迫的工作，他们很容易忽略那些已经过时的部分。

与此同时，在没有人员参与工作的情况下强制弃用会给客户带来恶意，这通常会阻碍弃用工作的顺利进行。客户只是把这种弃用工作看作是一种没有资金支持的委托，要求他们把自己的工作放在一边去执行这件事，只是为了保持服务的正常运行。这感觉很像原地踏步，并且会在运营人员和客户之间制造摩擦。正是由于这种原因，我们强烈主张强制性弃用是由专业团队通过完成的。

同样值得注意的是，即使有强有力的政策支持，强制性弃用仍然会面临政治障碍。想象一下，当旧系统的最后一个剩余用户是整个组织所依赖的基础设施的关键部分时，尝试强制使用旧系统。你还有所有依赖它的人有多愿意仅仅为了设定一个任意的最后期限去破坏这个基础设施？如果这个团队可以否决它的进展，很难相信贬低真的是强制性的。

谷歌的单片存储库和依赖关系图让我们对系统在整个生态系统中的使用有了深刻的了解。即使如此，一些团队可能甚至不知道他们依赖于一个过时的系统，并且很难通过分析发现这些依赖关系。也可以通过测试增加旧系统暂时关闭的频率和持续时间来动态地发现它们。这些有意地变更为通过观察中断来发现意想不到的依赖关系提供了一种机制，从而提醒团队需要为即将到来的截止日期做准备。在谷歌中，我们偶尔会更改仅实现符号的名称，以查看哪些用户不知情地依赖于它们。

通常在谷歌中，当系统计划要弃用或删除时，团队会在系统关闭前的几个月或几周内宣布计划中的停机。与谷歌灾难恢复测试(DiRT)类似，这些事件经常会发现运行中的系统之间未知的依赖关系。这种增量的方法使得那些依赖的团队发现并策划系统的最终删除，甚至会与弃用的团队一起调整他们的时间线。(同样的原则也适用于静态代码依赖，但是静态分析工具提供的语义信息通常足以检测过时系统的所有依赖。)

#### **警告弃用**

对于建议性和强制性弃用，使用程序自动将系统标记为弃用，这样用户就会在使用的时候被警告，并提醒其离开系统。人们往往倾向于把某件事标记为沮丧，并希望它的用途最终消失，但请记住:希望不是一种策略。弃用警告有助于阻止新的使用，但很少会导致现有系统的迁移。

通常情况下，这些警告会随着时间的推移而累积。如果它们在传递上下文中使用(例如，库A依赖于库B，而库B依赖于库C，而如果C发出警告，则在构建A时出现警告)，这些警告很快就会使系统的用户不知所措，以至于他们完全忽略它们。在卫生保健领域，这种现象被称为“警觉疲劳”。

向用户发出的任何弃用警告都需要具有两个属性:可操作性和相关性。如果用户可以使用警告来执行一些相关的行动，那么警告就是可行的，不仅仅是停留在理论上，而是在实践中给我们这个问题领域中专家的建议。例如，工具可能会警告，对给定函数的调用应该替换为对其更新后对应函数的调用，或者电子邮件可能会给出将数据从旧系统移动到新系统所需的步骤。在每一种情况下，警告提供了工程师永远不能执行的下一步，以不再依赖已弃用的系统。

警告虽是可行的，但仍然是恼人的。为了可用性，弃用警告应该是相关的。如果警告在用户实际执行指示的操作时出现，则该警告是相关的。对于已弃用函数的警告最好是在工程师正在编写使用该函数的代码时发出，而不是在该函数已写入存储库数周之后。同样，关于数据迁移的电子邮件最好在旧系统删除前几个月发送，而不是马后炮式地在删除发生前的一个周末才发送。

重要的是要抵制在所有可能的事情上都加上弃用警告。警告本身并不是坏事，但是简单的工具经常产生大量的警告消息，这可能会让毫无防备的工程师不知所措。在谷歌中，我们非常自由地将旧函数标记为弃用，但利用诸如ErrorProne或clang-tidy之类的工具来确保警告以有针对性的方式出现。正如第20章所讨论的，我们将这些警告限制在新更改的行中，以警醒人们关于已弃用符号的新用法。对于更有侵入性的警告，比如对依赖关系图中的已弃用目标的警告，只在强制弃用时才添加，团队正在积极地移除用户。在任何一种情况下，工具都在将适当的信息在适当的时间提供给适当的人员方面发挥着重要的作用，保证在不使用户感到疲劳的情况下添加更多的警告。

#### **管理弃用过程**

尽管它们感觉像是不同类型的项目，因为我们正在解构一个系统，而不是构建它，但报废项目在管理和运行方式上与其他软件工程项目类似。我们不会花太多精力去讨论这些管理方式之间的相似之处，但是需要指出他们之间的不同之处。

##### **流程负责人**

我们在谷歌中了解到，如果没有明确的负责人，无论系统可能发出多少警告和警报，弃用进程都不可能取得有意义的进展。让明确的项目所有者负责管理和推进弃用过程似乎是对资源的浪费，但是替代方案更糟糕:永远不要弃用任何东西，或者将弃用工作委托给系统的用户，第二种情况只是一种建议性的弃用，不会有组织地结束;第一种情况是承诺永远维护每一个旧系统。集中化折旧工作有助于更好地确保专业技术更加透明而实际降低成本。

在确定所有权和调整激励措施时，弃用项目经常会出现问题。每个规模合理的组织都有一些仍然在积极使用的项目，但是没有人清楚地拥有或维护这些项目，谷歌也不例外。项目有时会进入这种状态，因为它们已被弃用：最初的所有者已经转移到后续项目，留下过时的项目在基础设施中继续使用，该项目仍然是关键项目的依赖，并希望这个项目最终会消失。

这些项目不太可能自行消失，尽管我们抱有最大的希望，但我们发现这些项目仍然需要弃用专家来移除它们，防止它们在不恰当的时候失败。这些团队应该将移除作为他们的首要目标，而不是一些其他工作的次要项目。在优先级竞争的情况下，弃用工作总是被认为具有较低的优先级，很少得到它所需要的关注。这些重要但不紧急的清理任务占用了20%的时间，并为工程师提供了接触代码库其他部分的机会。

##### **时间表**

在建立一个新系统时，项目时间表通常是非常清楚的：“下个季度发布frobnazzer特性”。随着增量开发的实施，团队以增量的方式构建并交付功能，当用户使用新特性时，他们就取得了胜利。最终目标可能是启动整个系统，但是增量里程碑有助于给团队一种进步的感觉，使得他们不需要等到项目结束才为组织产生价值。

相反，在弃用过程中通常唯一里程碑就是完全删除过时的系统。在他们关灯回家之前，团队会觉得他们没有取得任何进展。尽管这对团队来说可能是最有意义的一步，但如果它正确地完成了工作，那么它通常是团队外部人员注意到的最少的一步，因为到那时，过时的系统就没有任何用户了。弃用项目经理应该抵制将其作为唯一可测量里程碑的诱惑，特别是考虑到它可能不会发生在所有弃用项目中。

与构建一个新系统类似，管理一个处理弃用的团队应该包括具体的增量里程碑，这是可度量的，并向用户交付价值。用来评估折旧过程的衡量标准会有所不同，但庆祝折旧过程中取得的增量成就仍然有利于鼓舞士气。我们发现识别适当的增量里程碑是很有用的，比如删除一个关键的子组件，就像我们在创建一个新产品时识别成就一样。

##### **弃用工具**

许多用于管理弃用过程的工具在本书的其他地方都进行了深入的讨论，比如大规模变更(LSC)过程(第22章)或我们的代码审查工具(第19章)。我们将简要概述这些工具在管理过时系统的废弃时如何发挥作用，而不是讨论这些工具的细节。这些工具可以分为发现、迁移和防倒退工具。

###### **发现**

在弃用过程的早期阶段，事实上在整个过程中，了解一个过时的系统是如何被使用的以及由谁使用的是非常有用的。弃用的大部分初始工作是确定谁在使用旧系统，以及以何种意想不到的方式使用。根据使用的不同，这个过程可能需要在获悉新信息后重新考虑弃用决定。我们还在弃用过程中使用这些工具来了解工作的进展情况。

在谷歌中，我们使用代码搜索(见第17章)和Kythe(见第23章)这样的工具来静态地确定哪些客户使用给定的库，并经常对现有的使用进行分析，以了解哪些行为出乎意料地依赖于客户。因为运行时的依赖性通常需要一些静态的库或瘦客户机的使用，这种技术产生了很多启动和推进弃用过程所需的信息。生产中的日志和运行时采样有助于发现动态依赖的问题。

最后，我们将全局测试套件作为一个oracle来确定是否所有对旧符号的引用都被删除了。如第11章所述，测试是在生态系统进化过程中防止系统不必要行为变化的一种机制。弃用是这一演变的重要组成部分，客户负责进行足够的测试，以确保删除过时的系统不会对他们造成损害。

###### **迁移**

谷歌的很多弃用工作都是通过使用我们前面提到的同一组代码生成和检查工具完成的。LSC进程和工具在管理实际更新代码库以参考新的库或运行时服务的大量工作时特别有用。

###### **防止倒退**

最后，在弃用过程中一个经常被忽视的部分是防止对添加新的工具。即使是建议性的弃用，在用户编写新代码时，警告他们不要使用已弃用的系统，而使用新的系统也是有用的。

如果没有倒退预防，弃用可能变成一场打地鼠游戏，用户不断地添加他们熟悉的系统的新用法(或在代码库的其他地方找到例子)，弃用团队不断地迁移这些新用法。这个过程既会适得其反，也会让人泄气。

为了防止在微观层面上出现倒退现象，我们使用Tricorder静态分析框架来通知用户他们正在向一个过时的系统添加调用，并向他们提供适当替换的反馈。已弃用系统的所有者可以向已弃用符号添加编译器注释(例如@deprecated Java注释)，而Tricorder会在审查时显示这些符号的新用法。这些注释将消息传递的控制权交给了拥有已弃用系统的团队，同时自动地向变更作者发出警报。在有限的情况下，工具还建议一个按钮修复来迁移到建议的替换。

在宏观层面上，我们在构建系统中使用可见性白名单，以确保新的依赖项不会被引入到已弃用的系统中。自动化工具会定期检查这些白名单，并在依赖系统从过时系统中迁移出来时对它们进行删除。

### **总结**

废弃感觉就像马戏团游行刚刚经过城镇后清理街道的脏活一样，但这些努力通过减少维护开销和工程师的认知负担，改善了整个软件生态系统。随着时间的推移，可伸缩地维护复杂的软件系统不仅仅是构建和运行软件:我们还必须能够删除过时或未使用的系统。

一个完整的弃用过程包括通过策略和工具成功地管理社会和技术挑战。作为组织的利益来源，以一种有组织有管理的方式弃用，其常常被忽视，但这对于组织的长期可持续性至关重要。

### **TL;DRs** 

- 软件系统有持续的维护成本，应该与移除它们的成本进行权衡。
- 删除东西通常比创建它们更难，因为现有用户经常以超出其最初设计的方式在使用系统。
- 如果把降低成本也包括在内的话，适当地改进一个系统通常比用一个新的替换它要便宜。
- 在决定是否降低成本时很难真实地去评估所涉及到的成本：除了保留旧系统所涉及的直接维护成本外，有多个相似的系统可供选择所涉及的生态系统成本可能需要交互操作。旧系统可能隐性地拖累新系统的功能开发，这些生态系统成本是分散的，难以衡量。类似地，折旧和弃用成本通常也是分散的。

 

 