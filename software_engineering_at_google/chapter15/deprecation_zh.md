# chapter 15

## **弃用**



*我爱最后期限。我爱它们飞驰而过时的呼啸声。*

*——道格拉斯**.**亚当斯*

所有系统老化。尽管软件是一种数字资产，其本身的物理部分不会退化，但随着时间的推移，新技术、库、技巧、语言和其他环境变化会使现有系统过时。因为旧的系统偏离周围的生态系统，它们需要持续、专业、更多精力的维护。将精力投入于关闭过时系统往往更好，而不是让它们无限期地与替代它们的系统并驾齐驱。但仍在运行的过时系统的数量表明，在实践中，这样做并非微不足道。我们将有序地迁移并最终移除过时系统的过程称为弃用。

与编程相比，弃用是更准确地属于软件工程学科的另一个主题，因为它需要考虑如何随着时间的推移管理系统。对于长期运行的软件生态系统，规划和执行弃用可以通过消除系统中随时间积累的冗余和复杂性来正确地降低资源成本和提高速度。另一方面，不受欢迎的系统可能比单独使用它们的成本更高。虽然弃用系统需要额外的工作，但可以在系统设计期间计划弃用，以便更容易最终停用和移除系统。折旧可能会影响从单个函数调用到整个软件堆栈的系统。 具体地，下面的大部分内容集中在代码级别的弃用。

与我们在本书中讨论的大多数其他主题不同，谷歌仍在学习如何最好地弃用和移除软件系统。这一章描述了我们已经学到的教训，因为我们已经否决了大型和大量使用的内部系统。有时，它能像预期的那样工作，有时却不能，但在工业界，删除过时系统的一般问题仍然是一个困难和不断发展的问题。

本章主要讨论不推荐的技术系统，而不是最终用户产品。考虑到面向外部的API只是另一种产品，而内部API可能拥有自认为是最终用户的消费者，这种区分有点武断。尽管许多原则适用于拒绝公共产品，但我们在这里关注的是在系统所有者能够了解其使用情况的情况下，淘汰和删除过时系统的技术和政策方面。


 

 

### **为什么要弃用？**

我们对折旧的讨论始于一个基本前提，即代码是一种负债，而不是一种资产。毕竟，如果代码是一种资产，我们为什么还要花时间去拒绝和删除过时的系统呢?代码有成本，其中一些是在创建系统的过程中承担的，但许多其他成本是在整个系统生命周期中维护时承担的。这些持续的成本，比如维持一个系统运行所需的运营资源，或者随着周围生态系统的进化而不断更新其代码库的努力，意味着在保持一个老化系统运行或努力关闭它之间进行权衡是值得的。

一个系统的年代并不足以证明它的过时。一个系统可以经过几年精心设计，成为软件形式和功能的缩影。一些软件系统，如LaTeX排版系统，在过去的几十年里得到了改进，尽管仍在发生变化，但变化非常少。仅仅因为一些东西是旧的，并不意味着它是过时的。

弃用最适用于明显过时的系统，并且存在提供类似功能的替换。新系统可以更有效地利用资源，具有更好的安全性能，以更可持续的方式构建，或者只是修复漏洞。让两个系统完成相同的任务似乎不是一个紧迫的问题，但随着时间的推移，维护它们的成本可能会大幅增加。用户可能需要使用新系统，但仍有一些依赖于使用旧系统。

这两个系统可能需要相互接口，这就需要复杂的转换代码。随着两个系统的发展，它们可能会彼此依赖，从而使最终移除其中任何一个变得更加困难。从长远来看，我们发现，拥有多个执行相同功能的系统也会阻碍新系统的发展，因为新系统仍然需要保持兼容性。花费精力去移除旧的系统可以得到回报，因为替换系统现在可以发展得更快。

早些时候，我们断言“代码是负债，而不是资产。”如果这是真的，为什么我们要花这本书的大部分时间来讨论构建可以存在几十年的软件系统的最有效的方法呢?为什么要花那么多精力去创造更多的代码，而这些代码最终只会出现在资产负债表的负债一侧?代码本身并没有带来价值:它所提供的功能才有价值。如果该功能满足用户需求，那么它就是一种资产:实现该功能的代码只是实现该目的的一种手段。如果我们可以从一行可维护的、可理解的代码中获得与10,000行复杂的意大利面条式代码相同的功能，我们会选择前者。代码本身也有成本——代码越简单，同时保持相同数量的功能，就越好。我们不应该关注我们能生成多少代码，或者我们的代码库有多大，我们应该关注每个代码单元能交付多少功能，并尽量最大化这个指标。做到这一点最简单的方法之一不是编写更多代码并希望获得更多功能;它删除了不再需要的多余代码和系统。弃用策略和过程使之成为可能。

尽管弃用是有用的，但我们从谷歌了解到，从做弃用的团队和这些团队的客户的角度来看，组织对同时进行合理的弃用工作量是有限制的。例如，虽然每个人都喜欢新铺的道路，但如果公共工程部门决定同时关闭所有道路进行铺路，没有人会去任何地方。通过集中他们的努力，铺路工人可以更快地完成特定的工作，同时也允许其他交通取得进展。同样，谨慎地选择弃用项目，然后致力于完成它们，这很重要。

### **为什么弃用这么难？**

我们在这本书的其他地方已经提到了Hyrum定律，但是值得在这里重复它的适用性:系统的用户越多，用户以意想不到的方式使用它的可能性就越高，并且也就越难弃用和删除这样的系统。它们的用法只是“碰巧管用”，而不是“保证管用”。在这种情况下，移除一个系统可以被认为是最终的改变:我们不只是改变行为，我们是完全移除行为!这种彻底的改变将使许多意想不到的依赖者摆脱出来。

更复杂的是，在提供相同(或更好)功能的新系统出现之前，弃用通常不是一个选项。新系统可能更好，但它也不同:毕竟，如果它与过时的系统完全相同，它不会为迁移到它的用户提供任何好处(尽管它可能有益于运营它的团队)。这种功能上的差异意味着新系统和旧系统之间很少有一对一的匹配，并且必须在新系统的环境中中评估旧系统的每次使用。

另一个令人惊讶的不愿弃用的是对旧系统的情感依恋，特别是那些弃用者帮助创建的系统。这种厌恶更改的一个例子发生在系统地删除谷歌中的旧代码时:我们偶尔会遇到“我喜欢这个代码!”要说服工程师拆除他们花费多年建造的东西是非常困难的。这是一个可以理解的反应，但最终会无效的:如果一个系统是过时的，它会给组织带来净成本，应该被删除。我们解决了在谷歌中保存旧代码的问题，其中一种方法是确保源代码库不仅可以在主干上搜索，而且可以在历史上搜索。即使已经删除的代码也可以再次找到(参见第17章)。

在谷歌中有一个古老的笑话:有两种方法:一种已经被弃用，另一种还没有准备好。这通常是新解决方案“几乎”完成的结果，也是在复杂且快节奏的技术环境中工作的不幸现实。

谷歌工程师已经习惯了在这种环境下工作，但它仍然令人不安。良好的文档、大量的路标和专家团队帮助处理废弃和迁移过程，这些都能让你更容易地知道你是应该使用带有缺点的旧东西，还是使用带有不确定性的新东西。

最后，在政治上，资助和执行折旧工作可能很困难;组建一个团队和花时间清除过时的系统需要花费真正的金钱，而什么都不做和让系统在无人看管的情况下运行的成本是不可观察到的。要让相关的利益相关者相信弃用的努力是值得的是困难的，特别是当它们对新功能的开发产生负面影响时。研究技术，如在第7章中描述的那些，可以提供具体的证据，说明一个弃用是值得的。

考虑到弃用和删除过时软件系统的困难，用户通常更容易就地发展一个系统，而不是完全替换它。增量心态并不能完全避免弃用过程，但它确实将其分解成更小、更易于管理的块，从而产生增量的好处。在谷歌中，我们观察到迁移到全新的系统非常昂贵，而且成本经常被低估。通过就地重构可以保持现有系统的运行，同时使其更容易地向用户传递价值。

### **设计期间的弃用**

像许多工程活动一样，软件系统的弃用可以在最初构建这些系统时进行计划。编程语言、软件架构、团队组成，甚至公司政策和文化的选择，都会影响到一个系统在其使用寿命结束后，移除它的容易程度。

设计系统从而使它们最终被弃用的概念在软件工程中可能是激进的，但在其他工程学科中是常见的。以核电站为例，这是一个极其复杂的工程。作为核电站设计的一部分，它的最终衰变-任务在一个生命周期的有效服务后，必须被考虑在内，甚至为此拨出资金。当工程师们知道核电站最终需要退役时，许多设计选择都会受到影响。

不幸的是，软件系统很少经过深思熟虑的设计。许多软件工程师被吸引到建造和推出新系统的任务上，而不是主要为现有系统服务。包括谷歌在内的许多公司的企业文化都强调快速制造和交付新产品，这往往会阻碍设计从一开始就考虑到弃用。尽管人们普遍认为软件工程师是数据驱动的自动机，但从心理上和逻辑上来讲，我们很难为我们正在努力建造的创造物的最终消亡做出计划。

那么，在设计将来更容易弃用的系统时，我们应该考虑哪些因素呢?以下是我们鼓励谷歌的工程团队提出的几个问题:

-  对于消费者来说，从我的产品迁移到潜在的替代品有多容易?

- 如何逐步替换系统的某些部分?

这些问题中的许多都与系统如何提供和使用依赖项有关。有关如何管理这些依赖关系的更详细讨论，请参见第16章。

最后，我们应该指出，当组织首次决定构建项目时，就决定是否长期支持项目。在软件系统存在之后，唯一剩下的选项是支持它，小心地弃用它，或者当某些外部事件导致它崩溃时让它停止运行。这些都是有效的选项，它们之间的权衡是特定于组织的。当公司破产时，一个只有一个项目的新公司会不假思索地扼杀它，但一个大公司在考虑移除旧项目时，需要更仔细地考虑对其对组合投资和声誉的影响。如前所述，谷歌仍在学习如何最好地利用我们自己的内部和外部产品进行这些权衡。

简而言之，不要启动组织没有承诺支持组织预期寿命的项目。即使组织选择弃用并删除项目，仍然会有成本，但是可以通过在工具和政策上的计划和投资来降低成本。

### **弃用的类型**

弃用不是一种单一的过程，而是一个连续的过程，从“我们希望有一天会关闭它”到“这个系统明天就会消失，用户们最好做好准备。”一般来说，我们把这一连续统一体分为两个独立的领域:建议性和强制性。

#### **建议性弃用**

建议性弃用的是那些没有截止日期，对组织来说不是高优先级的(并且公司不愿意为它们投入资源)。这些也可能被贴上“有志贬低”的标签:团队知道系统已经被替换了，尽管他们希望客户最终会迁移到新系统，但他们近期并没有提供支持以帮助客户迁移或删除旧系统的计划。这种弃用通常缺乏强制执行:我们希望客户端移动，但不能强迫他们移动。正如我们在SRE的朋友会很乐意告诉你的:“希望不是策略。”

建议性弃用是一个很好的工具，可以宣传新系统的存在，并鼓励早期采用该系统的用户开始尝试。这样的新系统不应该在测试阶段考虑:它应该为生产使用和负载做好准备，并且应该为无限期地支持新用户做好准备。当然，任何新系统都会经历成长的痛苦，但是在旧系统以任何方式被弃用之后，新系统将成为组织基础设施的关键部分。

我们在谷歌中看到的一种情况是，当新系统为用户提供了令人信服的好处时，建议性的弃用有很强的好处。在这些情况下, 简单地通知用户这个新系统，并为他们提供迁移到该系统的自助工具，通常会鼓励他们采用该系统。然而，这些好处不能是简单地增加:它们必须是变革性的。用户将不愿为边际利益而自行迁移，即使是具有巨大改进的新系统，如果只使用建议性的弃用工作，也不会获得完全的采用。

建议性弃用允许系统作者向期望的方向推动用户，但是不应该指望他们来完成大部分迁移工作。人们通常倾向于简单地对旧系统发出弃用警告，然后不做任何进一步的努力就退出。我们在谷歌的经验是，这可能会导致(稍微)较少的过时系统的新用法，但它很少会使得团队主动迁移。旧系统的现有用途对其产生了一种概念（或技术）上的吸引力：相对较多的旧系统的使用将倾向于获得大量的新用途，无论我们说多少，“请使用新的系统”。除非更积极地鼓励用户迁移，否则旧系统将继续需要维护和其他资源。 

 

 