### 第九章

### 代码评审
作者:汤姆·曼斯瑞克和凯特琳·萨多夫斯基
丽莎·凯里编辑

代码评审是指在将代码引入代码库之前，由作者以外的人审查的过程。虽然这是一个简单的定义，但是代码评审过程的实现在整个软件行业中有很大的不同。一些组织在代码库中有一组经过选择的“把关者”，他们负责审查变更。其他人将代码评审过程委托给较小的团队，允许不同的团队需要不同级别的代码评审。在谷歌，基本上每一个变更在提交之前都会被审查，每个工程师都负责发起审查和审查变更。

代码评审通常需要一个过程和支持该过程的工具的组合。在谷歌，我们使用定制的代码评审工具Critique来支持我们的流程。Critique在谷歌是一个足够重要的工具，在本书中有一整个章节来介绍它。本章着重于代码评审的过程，因为它是在谷歌而不是在特定的工具上实践的，这既是因为这些基础比工具更古老，也是因为这些见解中的大多数可以适用于您可能用于代码评审的任何工具。

代码评审的一些好处，比如在代码进入代码库之前检测代码中的错误，已经很好地建立起来了，并且有些明显(如果测量不精确的话)。然而，其他好处则更加微妙。因为谷歌的代码评审过程是如此的普遍和广泛，我们已经注意到了许多这些更微妙的影响，包括心理影响，这些影响随着时间和规模的推移给组织带来了许多好处。

#### 代码评审流程

代码评审可以发生在软件开发的许多阶段。在谷歌，在代码库发生变化之前需要进行代码评审；这一阶段也被称为预提交评审。代码评审的主要最终目标是让另一个工程师同意变更，我们通过将变更标记为“在我看来不错”(LGTM)来表示。我们使用LGTM作为必要的许可“位”(与下面提到的其他位相结合)，以允许提交更改。

谷歌的典型代码评审包括以下步骤:

1.用户在其工作空间中向代码库写入更改。然后作者创建了一个变更的快照:一个补丁和相应的描述被上传到代码评审工具。这种变化产生了与代码库之间的差异，代码库用于评估哪些代码发生了变化。
2.作者可以使用这个初始补丁来应用自动评论或进行自我评论。当作者对变更的差异感到满意时，他们会将变更发送给一个或多个审阅者。该过程通知这些审阅者，要求他们查看快照并对其进行评论。
3.审阅者在代码审阅工具中打开更改，并在diff上写上注释。一些评论要需要指出明确的解决办法。有些只是信息性的。
4.作者根据反馈修改变更并上传新的快照，然后回复给审阅者。步骤3和4可以重复多次。
5.在评审者对最新的变化状态感到满意后，他们通过标记“在我看来很好”来表示接受(LGTM)。默认情况下，只需要一个LGTM，尽管惯例可能会要求所有审查者同意更改。
6.只要作者解决了所有的注释标明的问题并且该变更被标记为LGTM之后，他们就可以将该变更提交给代码库。我们将在下一节讨论批准。

我们将在本章后面更详细地讨论这个过程。

#### 代码是一种责任

重要的是要记住(并接受)代码本身是一种责任。这可能是一项必要的责任，但就其本身而言，代码对某些人来说只是一项维护任务。很像飞机携带的燃料，尽管它有重量，却是飞机飞行所必需的。

当然，新特性通常是必要的，但是在开发代码之前，首先应该小心谨慎，以确保任何新特性都是有保证的。重复的代码不仅是一种浪费大家精力的事情，实际上比不写代码还要花费更多的时间；当代码库中存在重复时，会导致在一种代码模式下很容易执行的更改，通常需要更多的工作。写全新的代码是如此令人不快，以至于有些人说“如果你从头开始写，那你就做错了！”

库或实用程序代码尤其如此。很有可能，如果你正在编写一个应用程序，像谷歌这么大的代码库中的某个人可能也做过类似的事情。因此，第17章中讨论的工具对于找到这样的实用程序代码和防止引入重复代码都是至关重要的。理想情况下，这项研究是事先完成的，在编写任何新代码之前，任何新的设计都已经传达给了适当的团队。

当然，会出现新的的项目，引入新的技术，需要新的组件等等。综上所述，代码评审不是重复或讨论先前设计决策的机会。设计决策通常需要时间，需要重复审查设计方案建议，在应用编程接口评审或类似会议中对设计进行辩论，以及原型的开发。除了不应突然对全新的代码进行代码评审外，代码评审过程本身也不应该被看作是一个重新审视以前决策的机会。

#### 谷歌代码评审是如何工作的

我们已经大致指出了典型的代码评审过程是如何工作的，但是很多问题都出现在细节上。本节详细概述了代码评审在谷歌是如何工作的，以及这些实践如何允许它随着时间的推移适当地扩展。

在谷歌有三个方面的任何特定修改都需要“批准”的审查：

- 另一位工程师对代码的正确性和理解力进行检查，以确保代码是合适的，并且做了作者所声称的事情。这通常是一个团队成员，尽管不一定是。这反映在LGTM的权限 "位 "上，在同行评审员同意代码 "看起来不错 "之后，这个位就会被设置。

- 代码所有者之一批准该代码适用于代码库的这一特定部分(并且可以检查到特定目录中)。如果作者是这样的所有者，这种认可可能是隐含的。谷歌的代码库是一个树形结构，拥有特定目录的分层所有者。(见第16章)。所有者充当他们特定目录的看门人。任何工程师都可以提议修改，任何其他工程师都可以修改LGTM，但是有问题的目录的所有者也必须批准将这一部分添加到他们的代码库中。这样的所有者可能是技术主管或其他被认为是代码库特定领域专家的工程师。通常由每个团队决定分配所有权权限的范围。

- 具有语言“可读性”的人对代码符合语言风格和最佳实践的认可，检查代码是否按照我们期望的方式编写。如果作者有这样的可读性，这种认可也可能是隐含的。这些工程师是从全公司范围内拥有该编程语言可读性的工程师中挑选出来的。

虽然这种级别的控制听起来很麻烦——不可否认，有时确实如此——但大多数审查都是由一个人承担这三个角色，这就大大加快了进程。重要的是，作者也可以承担后两个角色，只需要另一个工程师的LGTM就可以将代码检查到他们自己的代码库中，前提是他们已经有了该语言的可读性(业主往往如此)。

这些需求使得代码评审过程非常灵活。一个技术负责人是一个项目的所有者，并且拥有该代码的语言可读性，他可以提交一个代码修改，只需要另一个工程师的LGTM。一个没有这种权力的实习生可以提交同样的修改到同一个代码库，只要他们得到一个拥有语言可读性的所有者的批准。上述三个许可 "位 "可以以任何组合结合。作者甚至可以向不同的人请求一个以上的LGTM，方法是明确地将该修改标记为希望得到所有审查者的LGTM。

在实践中，大多数需要一个以上批准的代码评审通常要经过两个步骤：从同行工程师那里获得LGTM，然后从适当的代码所有者/可读性审查者那里寻求批准。这使得两个角色可以专注于代码评审的不同方面，并节省审查时间。 首席审查员可以专注于代码的正确性和代码修改的一般有效性；代码所有者可以专注于这个修改是否适合他们的代码库的一部分，而不必专注于每一行代码的细节。换句话说，批准者通常在寻找与同行审查员不同的东西。"这段代码容易还是难以维护？""它是否增加了我的技术债务？""我们的团队中是否有维护它的专业知识？"

如果这三种类型的审查都可以由一个审查员来处理，为什么不直接让这些类型的审查员来处理所有的代码评审呢？简短的回答是规模。将这三种角色分开，可以增加代码评审过程的灵活性。 如果你和同行一起在一个实用程序库中开发一个新的函数，你可以让你团队中的某人来审查代码的正确性和可读性。经过几轮（可能是几天），你的代码满足了你的同行审查者，你得到了LGTM.现在，你只需要让库的所有者（而所有者往往有适当的可读性）批准这个变化。

#### 所有权 

当一个小团队在一个专门的资源库中工作时，通常会授予整个团队对资源库中所有内容的访问权。毕竟，你认识其他的工程师，这个领域很窄，你们每个人都可以成为专家，而且人数少会限制潜在错误的影响。

随着团队规模的扩大，这种方法可能无法扩展。其结果要么是混乱的版本库分裂，要么是用不同的方法来记录谁在版本库的不同部分拥有什么知识和责任。在谷歌，我们把这套知识和责任称为所有权，并把行使这些知识和责任的人称为所有者。这个概念不同于对源代码集合的占有，而是意味着一种管理意识，以公司的最佳利益对代码库的某个部分采取行动。(事实上，如果我们重新来过，"管家 "几乎肯定是一个更好的术语）。

特别命名的OWNERS文件列出了对一个目录及其子目录有所有权责任的人的用户名。这些文件也可能包含对其他OWNERS文件或外部访问控制列表的引用，但最终它们会解析为一个个人列表。 每个子目录也可以包含一个单独的OWNERS文件，而且这种关系是分层递增的：一个给定的文件通常由目录树中它上面的所有OWNERS文件的成员联合拥有。OWNERS文件可以有任何团队喜欢的条目，但我们鼓励一个相对较小和集中的列表以确保责任明确。

对谷歌代码的所有权传达了对其权限范围内的代码的批准权，但这些权利也伴随着一系列的责任，如了解所拥有的代码或知道如何找到了解的人。不同的团队有不同的标准来授予新成员的所有权，但我们一般鼓励他们不要把所有权作为一种入会仪式，并鼓励离任的成员在可行的情况下尽快放弃所有权。

这种分布式所有权结构使我们在本书中列出的许多其他做法成为可能。例如，根OWNERS文件中的一组人可以作为大规模修改的全球批准者（见第22章），而不必打扰本地团队。同样，OWNERS文件作为一种文档，使人们和工具很容易找到对某段代码负责的人，只要在目录树上查找即可。 当创建新的项目时，没有中央机构需要注册新的所有权权限：一个新的OWNERS文件就足够了。

这种所有权机制简单而强大，在过去的二十年中得到了很好的扩展。它是Google确保数以万计的工程师能够在一个库中的数十亿行代码上有效运作的方法之一。

#### 代码评审好处

在整个行业中，代码评审本身并没有争议，尽管它不是一种普遍的做法。许多（甚至可能是大多数）其他公司和开源项目都有某种形式的代码评审，而且大多数人认为这个过程很重要，是对将新代码引入代码库的理智检查。软件工程师理解代码评审的一些更明显的好处，即使他们个人可能不认为它适用于所有情况。但在谷歌，这个过程通常比大多数其他公司更彻底和广泛。

谷歌的文化，就像很多软件公司一样，是建立在给工程师广泛的自由度来完成他们的工作的基础上的。人们认识到，对于一个需要快速响应新技术的动态公司来说，严格的流程往往不能很好地工作，而官僚主义的规则往往不能很好地与创造性的专业人士合作。 谷歌要求对代码库中几乎所有的代码修改进行代码评审，无论多么小。这个任务确实对工程速度有成本和影响，因为它确实减缓了将新代码引入代码库的速度，并可能影响任何特定代码修改的生产时间。那么，为什么我们需要这个过程？为什么我们相信这是一个长期的好处？

一个精心设计的代码审查过程和一种认真对待代码审查的文化可以带来以下好处：
- 检查代码的正确性
- 确保其他工程师可以理解代码变更
- 增强整个代码库的一致性
- 从心理上促进团队主人翁精神
- 实现知识共享
- 提供代码审查本身的历史记录

随着时间的推移，这些好处对一个软件组织来说是至关重要的，并且其中许多好吃不仅对作者有益，而且对评审者也有益。下面的章节将对这些项目中的每一项进行更详细的说明。

##### 代码正确性

代码审查的一个明显好处是，它允许审查者检查代码变更的“正确性”。让另一双眼睛看着更改有助于确保这个变更达到了预期的目的。评审人员通常会检查变更是否经过了适当的测试，是否经过适当的设计以及是否可以正确有效地运行。在许多情况下，检查代码正确性就是在检查特定的更改是否会将错误引入代码库。

许多报告指出了代码审查有防止软件未来错误的功效。IBM的一项研究发现，在过程中尽早发现缺陷无疑会减少日后修复这些缺陷所需的时间。只要代码审查过程本身被精简以保持轻量级，在代码评审时间上的投资就可以节省在测试、调试和执行回归上所花费的时间。前提很重要；重量级的代码审查过程，或者不能适当扩展的代码审查过程，是不可持续的。在本章的后面，我们将介绍一些保持过程轻量级的最佳实践。

为了防止对正确性的评估变得主观多于客观，无论是在设计中还是引入的功能上的改变，作者通常会尊重他们的特定方法。评论家不应该因为个人观点的不同而提出替代方案。评审者可以提出替代方案，但前提是这些替代方案能够提高理解力(例如，通过降低复杂性)或功能(例如，通过提高效率)。一般来说，我们鼓励工程师批准那些能够改进代码库的更改，而不是等待对一个更“完美”的解决方案达成共识。这种关注倾向于加速代码审查的速度。

随着工具变得越来越强大，许多正确性检查都是通过静态分析和自动测试等技术自动执行的(尽管工具可能永远不会完全消除基于人的代码检查的价值——更多信息参见第20章)。尽管这种工具有它的局限性，但它确实减少了依赖人的代码审查来检查代码正确性的需要。

也就是说，在最初的代码审查过程中检查缺陷仍然是一般的“shift left”策略的一个重要部分，目的在于尽早发现和解决问题，以便不需要在开发周期的更远处增加成本和资源。代码审查既不是万能的，也不是正确性的唯一检查方法，但它是防止软件中出现此类问题的深度防御的一个要素。因此，代码审查不需要“完美”地获取结果。

令人惊讶的是，检查代码正确性并不是Google从代码审查过程中获得的主要好处。检查代码的正确性通常可以确保所做的变更是有效的，但是更加重要的是确保代码变更是可理解的，并且随着时间的推移和代码库本身的扩展而有意义。为了评估这些方面，我们需要查看除了代码在逻辑上是否“正确”或被理解之外的其他因素。

##### 代码理解

代码审查通常是作者以外的其他人检查更改的第一次机会。这种观点允许审查者执行一些即使是最好的工程师也做不到的事情：提供不受作者观点影响的反馈。代码评审是对一个给定的变更是否能被更多人理解的第一次测试。这种观点是至关重要的，因为代码被阅读的次数会比它被写的次数多得多，理解和领悟是非常重要的。

找到一个与作者有不同观点的审查者通常是有用的，特别是一个可能将需要维护或使用变更中提出的代码作为他们工作的一部分的审查员。与审阅者在设计决策方面应该给予作者的尊重不同，使用“客户永远是对的”这句格言来对待关于代码理解方面的问题通常是有用的。在某些方面，你现在得到的任何问题都会随着时间的推移而成倍增加，所以要把每一个关于代码理解的问题都看作是有效的。这并不意味着你需要改变你的方法或逻辑来回应批评，但这确实意味着你可能需要更清楚地解释它。

代码正确性和代码理解力的审查共同构成了另一个工程师的LGTM的主要标准，这也是一个被批准的代码审查所需的批准位之一。当一个工程师将代码审查标记为LGTM时，他们是在说，代码做到了它所说的事情，并且是可以理解的。然而，Google也要求代码是可持续维护的，因此在某些情况下，我们还需要对代码进行额外的批准。

##### 代码一致性

在一定程度上，你写的代码将被其他人所依赖，并最终得到维护。许多其他人需要阅读你的代码并理解你的工作。其他人(包括自动化工具)可能需要在你转移到另一个项目后很长时间内重构你的代码。因此，代码需要符合一些一致性标准，这样才能被理解和维护。代码也应该避免过于复杂；简单的代码对其他人来说也更容易理解和维护。在代码审查期间，审查者可以评估这个代码在多大程度上符合代码库本身的标准。因此，代码审查应该采取行动确保代码健康。

出于可维护性的考虑，代码评审的LGTM状态(表明代码的正确性和理解力)与可读性批准的状态是分开的。可读性批准只能由成功通过特定编程语言代码可读性培训的个人授予。例如，Java代码需要获得具有“Java可读性”的工程师的批准。

可读性批准者的任务是审查代码，以确保它遵循该特定编程语言的一致最佳实践，并与Google代码存储库中该语言的代码库保持一致，并避免过于复杂。一致且简单的代码更容易理解，并且在重构时工具更容易更新，使其更具弹性。如果一个特定的模式总是以一种方式在代码库中完成，那么编写一个重构它的工具就更容易了。

此外，代码可能只编写一次，但它将被读取数十次、数百次甚至数千次。在整个代码库中拥有一致的代码可以提高所有工程的理解力，这种一致性甚至影响到代码审查过程本身。一致性有时会与功能性发生冲突；可读性审查者可能更喜欢一个不太复杂的变更，它可能在功能上没有“更好”,但是更容易理解。

有了一个更一致的代码库，工程师可以更轻松地介入和审查其他人项目上的代码。工程师们可能偶尔需要在代码审查中向团队外寻求帮助。能够接触并要求专家审查代码与知道他们可以期望代码本身是一致的，这使得这些工程师能够更恰当地关注代码的正确性和理解力。

##### 心理和文化好处

代码审查也有重要的文化好处:它向软件工程师强调代码不是“他们的”，实际上是集体企业的一部分。这种心理上的好处可能很微妙，但仍然是重要的。如果没有代码审查，大多数工程师自然会倾向于个人风格和他们自己的软件设计方法。代码审查过程迫使作者不仅要让其他人提出意见，还要为了更大的利益做出妥协。

以自己的风格为荣，不愿意把自己的代码公开让别人审查批评，这是人类的天性。对于自己编写的代码的批评性反馈，也很自然地不愿意接受。代码审查过程提供了一种机制，来减少可能是充满情感的互动。当代码审查工作做得最好的时候，它不仅对工程师的假设提出挑战，而且以一种规定的、中立的方式进行审查，以缓和任何可能以不请自来的方式提供给作者的批评意见。毕竟，这个过程需要严格的审查(事实上我们称我们的代码审查工具为“批判”)，所以你不能责怪一个审查者做他们的工作并且是严格的。因此，代码审查过程本身可以充当“坏警察”，而审查者仍然可以被视为“好警察”。

当然，并不是所有的工程师，甚至不是大多数工程师都需要这样的心理装置。但是，通过代码审查过程来缓减这种批评，往往能为大多数工程师提供一个更温和的介绍，让他们了解团队的期望。许多加入Google或新团队的工程师被对代码审查感到恐惧。人们很容易认为，任何形式的批评性审查都会对一个人的工作表现产生负面影响。但是随着时间的推移，几乎所有的工程师都开始期待在发送代码审查时受到挑战，并开始重视通过这个过程提供的建议和问题(尽管不得不承认，这有时需要一段时间)。

代码审查的另一个心理好处是验证。即使是最有能力的工程师也可能患上冒名顶替综合症，并且过于自我批评。像代码评审这样的过程是对一个人的工作的验证和认可。通常，该过程涉及思想交流和知识共享(在下一节中讨论)，这对审查者和被审查者都有好处。随着工程师在其领域内知识的增长，他们有时很难获得关于他们如何改进的积极反馈。代码审查过程可以提供这种机制。

启动代码审查的过程也迫使所有作者对他们的变更多加注意。很多软件工程师并不是完美主义者；大多数人都会承认,“能完成工作”的代码比完美但开发时间太长的代码要好。如果没有代码审查，我们中的许多人自然会偷工减料，甚至完全打算在以后纠正这种缺陷。“当然，我没有完成所有的单元测试，但我可以稍后再做。”代码审查迫使工程师在发送变更之前解决这些问题。从心理学角度来说，为代码审查而收集变更的组成部分，迫使工程师确保他们所有的事情都是一帆风顺的。在发送变更前的那一小段思考时间，是阅读变更的最佳时机，以确保你没有遗漏任何东西。

##### 知识共享

代码审查一个重要的但被低估的好处是知识共享。大多数作者选择的审查员都是被审查领域的专家，或者至少是知识渊博的。审查过程允许审查者向作者传授领域知识，允许审查者向作者提供建议、新技术或咨询信息。(审查者甚至可以将一些评论标记为“仅供参考”，无需采取任何行动；它们只是作为对作者的帮助而添加的。)对代码库的某一领域特别精通的作者往往也会成为所有者，然后他们又可以作为其他工程师的审查者。

反馈和确认的代码审查过程的一部分包括询问为什么以特定的方式进行变更。这种信息交流有利于知识的共享。事实上，许多代码评审涉及到双向的信息交流：作者和审查者可以从代码审查中学习新的技术和模式。在谷歌，审查者甚至可以直接在代码审查工具中与作者分享建议的编辑内容。

工程师可能不会阅读每一封发给他们的电子邮件，但他们往往会回复每一封发送的代码审查。这种知识共享也可以跨时区和跨项目进行，使用Google的规模将信息迅速传播到代码库的各个角落的工程师。代码审查是知识转移的最佳时机：它是及时和可操作的。(Google的很多工程师都是首先通过代码审查“认识”其他工程师！)

鉴于Google工程师花在代码审查上的时间，积累的知识是相当重要的。当然，Google工程师的主要任务仍然是编程，但他们的很大一部分时间仍然花在代码审查上。代码审查过程提供了软件工程师之间相互交流和交换编码技术信息的主要方式之一。通常情况下，新的模式是在代码审查的背景下宣传的，有时是通过大规模的变更等重构。

此外，由于每一个变更都会成为代码库的一部分，所以代码审查就像一个历史记录。任何工程师都可以审查Google的代码库，并确定何时引入某些特定的模式，并提出有关的实际代码审查。通常情况下，考古学提供给工程师的见解要比原始作者和评论家多得多。

#### 代码审查最佳实践

诚然，代码审查会给一个组织带来异议和延迟。但这些问题大多不是代码审查本身的问题，而是他们选择的代码审查实施的问题。在Google保持代码审查过程的顺利运行也不例外，它需要大量的最佳实践来确保代码审查是值得的。这些实践中的大多数都强调要保持流程的灵活性和快速性，以便代码审查可以适当地扩展。

##### 礼貌和专业性

正如本书的文化部分所指出的，Google在很大程度上培养了一种信任和尊重的文化。这也渗透到我们对代码审查的看法中。例如，一个软件工程师只需要一个其他工程师的LGTM就可以满足我们对代码理解的要求。许多工程师提出意见，并在LGTM进行变更，他们的理解是，在这些变更完成后，可以提交变更，而不需要任何额外的审查。也就是说，即使是最有能力的工程师，代码审查也会给他们带来焦虑和压力。将所有的反馈和批评牢牢地保持在专业领域内是至关重要的。

一般来说，审查者应该在特定的方法上遵从作者的意见，只有在作者的方法有缺陷时才指出替代方法。如果作者可以证明几种方法同样有效，审查者应该接受作者的偏好。即使在这些情况下，如果发现一个方法有缺陷，也要把审查看作是一个学习的机会（对双方都是如此！）。所有的评论都应该严格保持专业性。审查者应该注意不要根据代码作者的特定方法妄下结论。在假设该方法是错误的之前，最好先问一下作者为什么要这样做。

审查者应及时提供反馈。在Google，我们希望在24小时内收到代码审查的反馈。如果审查者无法在这段时间内完成审查，那么最好的做法是（也是我们所期望的）回应说他们至少已经看到了更改，并会尽快进行审查。审查者应该避免以零散的方式回应代码评审。没有什么事情比从审查中得到反馈，解决它，然后继续在审查过程中得到无关的进一步反馈更让作者恼火。

就像我们期望审查员有专业精神一样，我们也期望作者有专业精神。记住，你不是你的代码，你提出的这个变更不是 "你的"，而是团队的。当你把这段代码放入代码库后，它就不再是你的了。要乐于接受关于你的方法的问题，并准备好解释你为什么以某种方式做事。记住，作者的部分责任是确保这段代码是可以理解的，并且可以在将来维护。

重要的是要把代码审查中的每个审查者的评论当作一个TODO项目；一个特定的评论可能不需要被无条件接受，但它至少应该被解决。如果你不同意一个评审员的评论，应当让他们知道，并让他们知道为什么，在双方都有机会提供替代方案之前，不要把评论标记为已解决。如果作者不同意评审员的意见，保持这种辩论的一个常见方法是提供一个替代方案，并要求评审员PTAL（请再看一看）。记住，代码评审对评审员和作者都是一个学习的机会。这种洞察力往往有助于减少任何分歧的机会。

同样的道理，如果你是代码的拥有者，并且在你的代码库中对代码审查做出回应，那么要对来自外部作者的修改持宽容态度。只要这个改动是对代码库的改进，你就应该尊重作者的意见，认为这个改动表明了一些可以而且应该改进的地方。

##### 写下微小的改变

要保持代码审查过程的灵活性，最重要的做法可能是保持小的变化。理想情况下，代码审查应该是容易消化的，并且对审查者和作者来说，都是集中在一个问题上。谷歌的代码审查过程不鼓励由完全成型的项目组成的大规模修改，审查员可以正确地拒绝这样的修改，因为它对于一次审查来说太大。较小的改动也避免了工程师在等待较大改动的审查时浪费了时间，减少了停机时间。这些小改动在软件开发过程中也有好处。如果一个特定的变更足够小，那么确定该变更中的错误来源就容易得多。

尽管如此，重要的是要承认，依靠小改动的代码审查过程有时很难与引进的主要新功能相协调。一组小的、渐进式的代码修改可能更容易单独消化，但在一个更大的计划中却更难理解。谷歌的一些工程师承认，他们并不喜欢对小改动的偏爱。存在管理这种代码变化的技术（在集成分支上开发，使用不同于头部的差异库来管理变更），但这些技术不可避免地涉及更多的开销。考虑到对小改动的优化只是一个优化，并允许你的过程适应偶尔的大改动。

一般来说，"小 "改动应该限制在200行左右的代码。一个小的改动对审查者来说应该是很容易的，而且，几乎同样重要的是，不要太过繁琐，以至于耽误了其他的改动来等待广泛的审查。谷歌的大多数代码变更预计将在大约一天内进行审查（这并不一定意味着审查在一天内结束，而是在一天内提供初步反馈）。在谷歌，大约有35%的修改是针对单个文件的。对审查者来说，这容易使代码库的变化更快，对作者也有利。作者希望得到快速的审查；等待一个星期左右的广泛审查可能会影响后续的修改。一个小的初始审查也可以防止在进一步的不正确的方法上浪费更多的精力。

因为代码审查通常是小规模的，所以在谷歌，几乎所有的代码审查都是由一个人审查，而且只有一个人。如果不是这样的话——如果一个团队被期望对一个共同的代码库的所有变化进行评估，那么这个过程本身就没有办法扩展。通过保持小规模的代码审查，我们实现了这种优化。多人对任何给定的变化发表评论的情况并不罕见——大多数代码审查被发送给一个团队成员，但也被抄送给适当的团队——但主要的审查者仍然是那个希望得到LGTM的人，而且对于任何给定的变化，只有一个LGTM是必要的。任何其他评论，尽管很重要，但仍然是可选的。

保持小的变化也允许 "批准 "审查员更快地批准任何特定的变化。他们可以快速检查主要的代码审查员是否尽职尽责，并纯粹关注这一变化是否增强了代码库，同时随着时间的推移保持代码的健康。

##### 写好变更描述

变更描述应该在第一行指出它的变更类型，作为一个摘要。第一行是主要的位置，用于在代码审查工具本身中提供摘要，作为任何相关电子邮件的主题行，并成为谷歌工程师在代码搜索的历史摘要中看到的可见行（见第17章），所以第一行很重要。

尽管第一行应该是对整个修改的总结，但描述仍然应该详细说明被修改的内容和原因。一个 "错误修复"的描述对审查员或未来的代码考古学家来说是没有帮助的。如果在修改中做了几个相关的修改，可以在一个列表中列举它们（同时仍然保持信息和小规模）。描述是这个修改的历史记录，像代码搜索这样的工具可以让你找到代码库中任何特定的修改中谁写了哪一行。在试图修复一个bug的时候，深入到原始变化中去往往是有用的。

描述并不是为一个变化添加文档的唯一机会。在编写公共API时，你通常不想泄露实现的细节，但在实际实现中，你应该随意地进行注释。如果审查者不理解你为什么要这么做，即使它是正确的，这也是一个很好的指标，说明这些代码需要更好的结构或更好的注释（或两者兼而有之）。如果在代码审查过程中，达成了新的决定，请更新修改说明，或在实现中添加适当的注释。代码审查不仅仅是你在当下做的事情，它也是你为后代记录你所做的事情的事情。

##### 尽量减少审查员

谷歌的大多数代码审查都是由一个审查者审查的。由于代码审查过程允许由一个人处理代码的正确性、所有者的接受度和语言的可读性，因此代码审查过程在谷歌这样的组织规模中具有相当好的扩展性。

在行业内，以及在个人内部，有一种趋势是试图从跨部门的工程师那里获得额外的投入（和一致同意）。毕竟，每个额外的审查员都可以为有关的代码审查增加他们自己的特殊见解。但是我们发现这会导致收益递减。最重要的LGTM是第一个，随后的几个没有你想象的那么多。额外审核人员的成本很快就超过了他们的价值。

代码审查过程是围绕着我们对工程师做正确事情的信任而优化的。在某些情况下，让一个特定的变化由多人审查可能是有用的，但即使在这些情况下，这些审查者也应该专注于同一变化的不同方面。

##### 尽可能自动化

代码审查是一个人的过程，人的投入是很重要的，但如果有一些编码过程中的某些部分可以自动化，请尝试这样做。应该探索将机械性的人类任务自动化的机会；在适当的工具上的投资可以获得回报。在谷歌，我们的代码审查工具允许作者在批准后自动提交并自动同步修改到源码控制系统（通常用于相当简单的修改）。

在过去的几年中，关于自动化的最重要的技术改进之一是对给定的代码修改进行自动静态分析（见第20章）。目前的Google代码审查工具不需要作者运行测试，摘要或格式化程序，而是通过预提交自动提供大部分的效用。当变更最初发送给审查者时，运行预提交流程。在发送更改之前，预提交过程可以检测现有更改的各种问题，拒绝当前的更改（并防止向审阅者发送尴尬的电子邮件），并要求原始作者首先修复更改。这种自动化不仅有助于代码审查过程本身，还允许审查者关注比格式化更为重要的问题。

#### 代码审查的类型

所有的代码审查都是不一样的！不同类型的代码审查需要对审查过程中的各个环节进行不同程度的关注。在谷歌，代码修改一般都属于以下几个方面（尽管有时会有重叠）。

- 绿地审查和新功能开发
-  行为变化、改进和优化
- 错误修复和回滚
- 重构和大规模变化

##### 绿地代码评论

最不常见的代码审查类型是全新的代码，即所谓的绿地审查。绿地审查是评估代码是否经得起时间考验的最重要时机：随着时间和规模的变化，代码的基本假设会更容易维护。当然，引入全新的代码不应该是一个惊喜。正如本章前面提到的，代码是一种责任，所以引入全新的代码通常应该解决一个真正的问题，而不是简单地提供另一种选择。在Google，除了代码审查之外，我们一般要求新的代码和/或项目要经过广泛的设计审查。代码审查不是辩论过去已经做出的设计决定的时候（同样道理，代码审查也不是介绍建议的API设计的时候）。

为了确保代码是可持续的，绿地审查应该确保API与商定的设计相匹配（这可能需要审查设计文件），并进行充分的测试，所有的API端点都有某种形式的单元测试，并且这些测试在代码的假设发生变化时失效。(见第11章)。代码还应该有适当的所有者（新项目的第一次审查通常是对新目录的一个单一的OWNERS文件的审查），有足够的评论，并在需要时提供补充的文件。绿地审查也可能需要将项目引入持续集成系统。(见第23章)。

##### 行为改变、改进和优化

谷歌的大多数变化通常属于对代码库中的现有代码的广泛修改。这些补充可能包括对API端点的修改，对现有实现的改进，或对其他方面（如性能）的优化。这种变化是大多数软件工程师的谋生之道。

在每一种情况下，适用于绿地审查的准则也适用：这种改变是否必要，这种改变是否能改善代码库？对代码库的一些最好的修改实际上是删除！摆脱死的或过时的代码是改善代码库整体代码健康的最好方法之一。

任何行为上的修改都应该包括对任何新的API行为的适当测试的修订。对实现的扩展应该在持续集成（CI）系统中进行测试，以确保这些修改不会破坏现有测试的任何基本假设。同样，优化当然应该确保它们不会影响这些测试，并且可能需要包括性能基准，供评审者参考。 一些优化可能还需要基准测试。

##### 错误修复和回滚

不可避免的是，你需要提交一个修改来修复你的代码库的错误。当这样做的时候，要避免处理其他问题的诱惑。这不仅有可能增加代码审查的规模，也会使执行回归测试或其他人回滚你的变化变得更加困难。一个错误修复应该只关注于修复指定的错误和（通常）更新相关的测试来捕捉首先发生的错误。

用修改后的测试来解决这个bug通常是必要的。bug的出现是因为现有的测试不充分，或者代码中的某些假设没有得到满足。作为bug修复的审查者，如果适用的话，要求更新单元测试是很重要的。

有时，像谷歌这样庞大的代码库中的代码变更会导致某些依赖性失效，而这些依赖性要么没有被测试正确检测到，要么是发现了代码库中未经测试的部分。在这些情况下，谷歌允许此类变更被 "回滚"，通常是由受影响的下游客户进行回滚。回滚由一个本质上撤销了前一个更改的更改组成。这种回滚可以在几秒钟内创建，因为它们只是将以前的更改恢复到已知状态，但它们仍然需要代码审核。

同样重要的是，任何可能导致潜在回滚的变化（包括所有的变化！）都要尽可能小，而且是原子性的，这样，如果需要回滚，就不会导致其他难以解开的依赖关系的进一步破坏。在谷歌，我们看到开发人员在新代码提交后很快就开始依赖它，因此回滚有时会让这些开发人员崩溃。小的变更有助于减轻这些担忧，这既是因为它们的原子性，也是因为对小变更的审查往往会很快完成。

##### 重构和大规模变化

在谷歌，许多变化是自动生成的：变化的作者不是人，而是机器。我们在第22章中讨论了更多关于大规模变化（LSC）的过程，但即使是机器生成的变化也需要审查。在变化被认为是低风险的情况下，它被指定的审查员审查，他们对我们整个代码库有审批权限。但是对于变更可能有风险或需要本地领域专业知识的情况，个别工程师可能会被要求审查自动生成的变更，作为其正常工作过程的一部分。

乍一看，对自动生成的变更的审查应该和其他的代码审查一样：审查者应该检查变更的正确性和适用性。然而，我们鼓励审查者在相关的变更中限制评论，并且只标记针对其代码的关注，而不是生成变更的基础工具或LSC。虽然具体的变化可能是由机器产生的，但产生这些变化的整体过程已经被审查过了，个别团队不能对这个过程持有否决权，否则就不可能在整个组织内扩展这种变化。如果对基础工具或过程有担忧，审查者可以升级到LSC监督小组，以获得更多信息。

我们也鼓励自动变更的审查者避免扩大他们的范围。当审查一个新的功能或一个由团队成员编写的变更时，要求作者在同一个变更中解决相关的问题通常是合理的，只要要求仍然遵循先前的建议，保持小的变更。这不适用于自动生成的变更，因为运行工具的人可能有数百个变更在飞行，即使是一小部分有审查意见或不相关问题的变更也限制了人类能够有效操作工具的规模。

#### 总结

代码审查是谷歌最重要和最关键的流程之一。代码审查是连接工程师之间的粘合剂，代码审查流程是主要的开发人员工作流程，几乎所有其他流程都必须依靠它，从测试到静态分析到CI。代码审查流程必须有适当的规模，因此，最佳做法，包括小的变化和快速反馈和迭代，对于保持开发人员的满意度和适当的生产速度非常重要。

#### 太长，所以不用看（Too Long; Don't Read.）

- 代码审查有很多好处，包括确保代码的正确性、兼容性和整个代码库的一致性。
- 始终通过别人来检查你的假设；为读者进行优化。 
- 在保持专业性的同时提供批评性反馈的机会。
- 代码审查对于整个组织的知识共享非常重要。 
- 自动化对于流程的扩展至关重要。
- 代码审查本身提供了一个历史记录。