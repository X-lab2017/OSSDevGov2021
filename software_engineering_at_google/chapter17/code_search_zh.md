# 第十七章

## 代码搜索

*作者：亚历山大·纽贝克（Alexander Neubeck）和本·圣约翰（Ben St.John）*

*编辑：Lisa Carey*


代码搜索是一个在谷歌上浏览和搜索代码的工具，它由一个前端UI和各种后端元素组成。与谷歌上的许多开发工具一样，它直接产生于需要扩展到代码库的大小的需要。代码搜索最初是将内部代码的grep类型工具[^1]与外部代码搜索的排名和UI的组合。[^2]它作为谷歌开发者的关键工具的地位得到了集成Kythe/Grok的巩固，[^3]增加了交叉引用和跳转到符号定义的能力。

这种集成将它的焦点从搜索变成了浏览代码，后来的代码搜索的设计选择的部分原则是“一键回答代码”。现在像“这个符号定义了哪里？”在哪里？”、“它在哪里？”、“我如何包括它？”、“它是什么时候添加到代码库的”？甚至是像“车队消耗的CPU周期？”这样的问题都要由一两次点击负责。

与集成开发环境(IDE)或代码编辑器相比，代码搜索是针对大规模阅读、理解和探索代码的用例进行了优化的。为此，它在很大程度上依赖于基于云的后端来搜索内容和解决交叉引用。



------

1: GSearch最初运行在杰夫·迪恩的个人电脑上，这曾经在他去度假时引起了整个公司的痛苦，结果它被关闭了！

2: 在2013年关闭；请参阅https://en.wikipedia.org/wiki/Google_Code_Search。

3: 现在被称为Kythe，一种提供交叉引用（除其他内容外）的服务：使用一个特定的代码符号（例如，一个函数），使用完整的构建信息来消除它与其他同名的构建信息的歧义。

---

351


在本章中，我们将更详细地介绍代码搜索，包括谷歌用户如何将其作为开发人员工作流的一部分，为什么我们选择开发单独的web工具，并检查它如何解决谷歌存储库规模搜索和浏览代码的挑战。

### 代码搜索用户界面
搜索框是代码搜索用户界面的中心元素（参见图17-1），与Web搜索一样，开发人员可以用来快速导航到文件、符号或目录。对于更复杂的用例，将返回一个带有代码片段的结果页。搜索本身可以被认为是一个即时的“在文件中查找”(如Unixgrep命令)，具有相关性排名和一些特定于代码的增强，如适当的语法突出显示、范围意识以及对注释和字符串文本的认识。也可以从命令行获得搜索，并且可以通过远程过程调用(RPC)API合并到其他工具中。当需要后处理或结果集太大而无法手动检查时，这就会派上用场。

![avatar](./images/17-1.png)

图17-1.代码搜索界面

查看单个文件时，大多数令牌都可单击，让用户快速导航到相关信息。例如，函数调用将链接到其函数定义、导入的文件名链接到实际的源文件名，或对相关支持错误报告的注释中的bugID。这是由基于编译器的索引工具提供的。单击符号名称将打开一个包含使用该符号的所有位置的面板。

---
352 |第17章：代码搜索

相似地，悬停在函数中的局部变量上将突出显示该变量在实现中的所有出现情况。代码搜索还通过文件与Piper的集成显示文件的历史（参见第16章）。这意味着看到文件的旧版本，这些变化影响了它，谁写了它们，在评论中跳到它们（见第19章），不同版本的文件，如果需要的话，经典的“指责”视图。甚至是被删除的文件也可以从目录视图中看到。
### Google员工如何使用代码搜索？
虽然在其他工具中也可以使用类似的功能，但谷歌用户仍然大量使用代码搜索用户界面来搜索和文件查看，并最终使用站立代码。[^4]工程师试图完成代码搜索的任务可以被认为是回答有关代码的问题，并且重复的意图变得可见。[^5]

#### Where？
大约16%的代码搜索试图回答代码库中哪里存在特定信息的问题；例如，函数定义或配置，API的所有用法，或者只是特定文件在存储库中的位置。这些问题非常有针对性，可以通过搜索查询或遵循语义链接来非常精确地回答，比如“跳到符号定义”。这类问题经常出现在更大的任务中，如重新分解/清理，或者在在项目中与其他工程师合作时。因此，必须有效地解决这些较小的知识差距。

代码搜索提供了两种帮助方法：对结果进行排序和丰富的查询lan猜测。排名解决了常见的情况，搜索可以非常具体（例如，限制代码路径，不包括语言，只考虑函数）来处理更罕见的情况。

该用户界面便于与同事共享代码搜索结果。因此，对于代码审查，您可以简单地包括链接—例如，“您是否考虑过使用此专门的哈列映射：cool_hash.h？”，这对于文档、错误报告和时候检查中也非常有用，并且引用代码是谷歌用户在谷歌内。甚至可以引用较旧版本的代码，因此链接可以随着代码库的发展而保持有效。

---
4：有一个无处不在的代码浏览器所鼓励的有趣的良性循环：编写易于浏览的代码。这可能意味着不要嵌套层次结构，这需要多次点击才能从调用站点移动到实际实现，并使用命名类型而不是字符串或整数等通用类型，因为这样就很容易找到所有的用法。

5：萨多夫斯基，凯特琳，凯瑟琳·斯托利和塞巴斯蒂安·埃尔鲍姆。“开发人员如何搜索代码：案例研究”，2015年第10届联席会议（ESEC/FSE2015）。https://doi.org/10.1145/2786805.2786855.

---
Google员工如何使用代码搜索？ | 353


#### What？
大约四分之一的代码搜索是经典的文件浏览，以回答代码库的特定部分在做什么的问题。这些任务通常更具有探索性，而不是定位一个特定的结果。这是指使用代码搜索来读取源代码，以便在进行更改之前更好地理解代码，或者能够理解其他人的更改。

为了简化这类任务，代码搜索引入了通过调用层次结构的浏览和在相关文件之间（例如，在标头、实现、测试和构建文件之间）的快速导航。这是关于通过轻松地回答开发人员在查看代码时遇到的每一个问题来理解代码。

#### How？
最常见的用例，大约三分之一的代码搜索，是关于看到其他人如何做什么的例子。通常，开发人员已经找到了一个特定的API（例如，如何从远程存储中读取文件），并希望了解如何将该API应用于特定的问题（例如，如何稳健地设置远程连接并处理某些类型的错误）。代码搜索还首先用于为特定问题找到合适的库（例如，如何有效地计算整数值的指纹），然后选择最合适的整数表示。对于这类任务，搜索和交叉引用浏览的结合非常典型。

#### Why？
与代码在做什么有关，关于为什么代码的行为与预期的不同，有更有针对性的查询。大约16%的代码搜索会试图回答为什么会添加某段代码，或者为什么它会以某种方式行为的问题。这类问题经常在调试过程中出现；例如，为什么在这种特殊情况下会发生错误？

这里的一个重要功能是能够在一个特定的时间点搜索和探索代码库的确切状态。在调试生产问题时，这可能意味着使用数周或数月的代码库状态，而为新代码调试测试失败通常意味着处理仅几分钟的更改。两者都可以通过代码搜索来实现。

---
354 |第17章：代码搜索

#### Who and When？
大约8%的代码搜索会试图回答关于谁或何时引入某段代码，与版本控制系统交互的问题。例如，可以看到何时引入了特定的行（如Git的“责任”），并跳转到相关的代码审查。这个历史记录面板也可以对寻找询问代码或查看代码更改的最佳人选非常有用。[^6]

### 为什么要使用单独的Web工具？
在Google之外，上述大多数调查都是在本地IDE内进行的。那么，为什么还要使用另一个工具呢？

#### 规模
第一个答案是，谷歌代码库如此之大，因此完整代码库的本地副本（大多数IDE的先决条件）根本不适合在单台机器上。甚至在这一基本障碍被击中之前，为每个开发人员构建本地搜索和交叉参考索引就会有成本，这一成本通常在IDE启动时支付，减慢了开发人员的速度。或者，没有索引，一次性搜索（例如，grep）会变得非常慢。集中的搜索索引意味着预先做一次这项工作，并意味着在这个过程中的投资使每个人都受益。例如，代码搜索索引会随着每次提交的更改而增量更新，从而实现具有线性成本的索引构建。[^7]

在正常的网络搜索中，快速变化的时事与更缓慢变化的项目混合在一起，比如稳定的维基百科页面。同样的技术也可以扩展到搜索代码上，建立增量索引，从而降低其成本，并允许每个人都能立即看到对代码库的更改。当提交代码更改时，只需要重新对所触摸的实际文件进行索引，这允许对全局索引进行并行和独立的更新。

不幸的是，交叉引用索引不能立即以同样的方式进行更新。增量是不可能的，因为任何代码更改都可能会影响整个代码库，而且在实际操作中通常会影响数千个文件。

---
6：也就是说，考虑到机器生成的变化的提交率，幼稚的“责任”跟踪不如它在更厌恶变化的生态系统中的价值。

7：为了比较，“每个开发人员在自己的工作空间上都有自己的IDE进行索引计算”的模型大致是二次扩展的：开发人员每单位时间生成的代码大致不变，因此代码库线性扩展（即使是固定数量的开发人员也可以）。线性数量的IDE每次都做线性更多的工作，这不是良好扩展的方法。
几乎所有的谷歌的完整二进制文件需要构建[^8]（或至少进行分析）来确定完整的语义结构。它每天使用大量的计算资源来生成索引（当前的频率）。即时搜索索引和每日交叉引用索引之间的差异是用户罕见但经常出现的问题

---
为什么要使用单独的Web工具？ | 355


### 零设置全局代码视图
能够立即、有效地浏览整个代码库意味着很容易找到要重用的相关库，并且可以复制良好的示例。对于在启动时包含结构索引的ide，有一个小项目或可见范围，以减少这次时间，避免淹没像自动完成噪音这样的工具。使用代码搜索web用户界面，不需要安装（例如，项目描述、构建环境），因此可以轻松快速了解代码，提高开发人员的效率。也没有丢失代码依赖关系的危险，例如，当更新API时，减少了合并和库的版本控制问题。

#### 特殊化
也许令人惊讶的是，代码搜索的一个优点是它不是一个IDE。这意味着用户体验(UX)可以被优化来浏览和理解代码，而不是编辑它，这通常是IDE的大部分（例如，键盘快捷键、菜单、鼠标点击，甚至屏幕空间）。例如，由于没有编辑器的文本游标，每次鼠标点击一个符号都会显得有意义（例如，显示所有用法或跳转到定义），而不是作为移动游标的一种方式。这种优势非常大，因此开发人员通常会与编辑器同时打开多个代码搜索选项卡。

#### 与其他开发人员工具的集成

由于它是查看源代码的主要方式，因此代码搜索是公开有关源代码信息的逻辑平台。它释放了工具创建者不需要为他们的结果创建一个用户界面，并确保整个开发人员的观众将知道他们的工作，而不需要做广告。许多分析经常在整个谷歌代码库上运行，它们的结果通常出现在代码搜索中。例如，对于许多语言，我们可以检测“dead”（未调用）代码并在浏览文件时标记。

---
8：Kythe利用构建工作流从源代码中提取语义节点和边。此提取过程为每个单独构建规则收集部分交叉参考图。在随后的阶段，这些标准图被合并到一个全局图中，它的表示针对最常见的查询（进入定义、查找所有用法、获取文件的所有装饰）进行了优化。每个阶段提取和后处理大致与完整构建一样昂贵，例如，对于铬，Kythe指数的构建是在分布式设置中大约6小时内完成的，因此每个开发人员在自己的工作站上构建的成本太高。这种计算成本就是为什么基指数每天只计算一次的原因。

---

356 |第17章：代码搜索


另一方面，指向源文件的代码搜索链接被认为是其标准的“位置”。这对许多开发人员工具都很有用（见图17-2）。例如，日志文件行通常包含日志记录语句的文件名和行号。生产日志查看器使用代码搜索链接将日志语句连接回生产代码。根据可用的信息，这可以是直接链接到特定版本中的文件，也可以是具有相应行号的基本文件名搜索。如果只有一个匹配的文件，则会以相应的行号打开它。否则，将呈现每个匹配文件中所需行的片段。

![avatar](./images/17-2.png)

图17-2.日志查看器中的代码搜索集成

类似地，堆栈帧也会重新链接到源代码，无论它们是显示在崩溃报告工具中还是显示在日志输出中，如图17-3所示。根据编程语言，链接将使用文件名或符号搜索。由于构建崩溃二进制文件的存储库的快照是已知的，因此搜索实际上可以完全限制在这个版本内。这样，链接在很长一段时间内仍然有效，即使相应的代码后来被重构或删除。

---
为什么要使用单独的Web工具？ | 357